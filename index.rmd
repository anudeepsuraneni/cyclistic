---
title: "Cyclistic Bike-share Analysis"
output: html_document
date: "`r Sys.Date()`"
---

# Load required libraries
```{r load-libraries, echo=FALSE}
library(tidyverse) # helps wrangle data
library(conflicted) # to manage conflicts

# set dplyr::filter and dplyr::lag as the default choices
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
```

# Load datasets here
```{r upload-datasets, echo=FALSE}
q1_2019 <- read_csv(
  "divvy-tripdata/Divvy_Trips_2019_Q1/Divvy_Trips_2019_Q1.csv"
)
q1_2020 <- read_csv(
  "divvy-tripdata/Divvy_Trips_2020_Q1/Divvy_Trips_2020_Q1.csv"
)
```

# Inspect column names in each data frame
```{r compare-dataframes, echo=FALSE}
cat(
  "Column names of 2019 Q1 dataframe:",
  paste(colnames(q1_2019), collapse = ", "), "\n"
)
cat(
  "Column names of 2020 Q1 dataframe:",
  paste(colnames(q1_2020), collapse = ", "),
  "\n"
)
```

# Rename columns in q1_2019 to make it consistent with q2_2020 (as this will be supposed going-forward table design for Divvy)
```{r rename-columns, echo=FALSE}
q1_2019 <- q1_2019 %>%
  rename(
    ride_id = trip_id,
    rideable_type = bikeid,
    started_at = start_time,
    ended_at = end_time,
    start_station_name = from_station_name,
    start_station_id = from_station_id,
    end_station_name = to_station_name,
    end_station_id = to_station_id,
    member_casual = usertype
  )
```

# Inspect the data frames and look for inconsistencies 
```{r inspect-dataframes, echo=FALSE}
str(q1_2019)
str(q1_2020)
```

# Convert ride_id and rideable_type to character type so they can stack correctly.
```{r convert-types, echo=FALSE}
q1_2019 <- q1_2019 %>%
  mutate(
    ride_id = as.character(ride_id),
    rideable_type = as.character(rideable_type)
  )
```

# Merge individual data frames into one big data frame.
```{r merge-dataframes}
all_trips <- bind_rows(q1_2019, q1_2020)
```

# Remove fields that are not common in both data frames.
```{r remove-uncommon-columns}
all_trips <- all_trips %>%
  select(
    -c(tripduration, gender, birthyear, start_lat, start_lng, end_lat, end_lng)
  )
```

# List out the column names of the data frame.
```{r column-names}
paste(colnames(all_trips), collapse = ", ")
```

# How many rows are in the data frame?
```{r rows-count}
nrow(all_trips)
```

# Dimensions of the data frame?
```{r df-dimensions}
dim(all_trips)
```

# See the first 6 rows of the data frame.
```{r df-head}
head(all_trips)
```

# See the last 6 rows of the data frame.
```{r df-tail}
tail(all_trips)
```

# See the list of columns and data types of the data frame.
```{r df-structure}
str(all_trips)
```

# Statistical summary of the data (mainly numeric).
```{r df-summary}
summary(all_trips)
```

# How many observations fall under each rider type?
```{r user-types}
table(all_trips$member_casual)
```

# In the member_casual column, replace "Subscriber" with "member" and "Customer" with "casual". Before 2020, Divvy used different labels for these two types of riders. We will want to make our data frame consistent with the current format.
```{r member-casual-types}
all_trips <- all_trips %>%
  mutate(member_casual = recode(member_casual,
                                "Subscriber" = "member",
                                "Customer" = "casual"))
table(all_trips$member_casual)
```

# Add columns that list the date, month, day, and year of each ride.
```{r date-columns}
all_trips$date <- as.Date(all_trips$started_at)
all_trips$month <- format(all_trips$date, "%m")
all_trips$day <- format(all_trips$date, "%d")
all_trips$year <- format(all_trips$date, "%Y")
all_trips$day_of_week <- format(all_trips$date, "%A")
```

# Add a ride_length column (in seconds).
```{r calc-ride-length}
all_trips$ride_length <- difftime(all_trips$ended_at, all_trips$started_at)
```

# Inspect the structure of the columns.
```{r df-str}
str(all_trips)
```

# Convert ride_length into numeric for data calculations.
```{r transform-ride-length}
all_trips$ride_length <- as.numeric(as.character(all_trips$ride_length))
is.numeric(all_trips$ride_length)
```

# Remove "bad" data. The data frame includes entries when bikes were taken out of docks and checked for quality by Divvy or ride_length was negative.
```{r remove-bad-data}
all_trips_v2 <- all_trips[
  !(all_trips$start_station_name == "HQ QR" | all_trips$ride_length < 0),
]
cat(nrow(all_trips) - nrow(all_trips_v2), "rows with bad data are removed.")
```

# Descriptive analysis on ride_length (all figures in seconds).
```{r ride-length-desc}
cat("Average ride length:", mean(all_trips_v2$ride_length), "seconds.\n")
cat(
  "Midpoint number in the acending array of ride lengths:",
  median(all_trips_v2$ride_length), "seconds.\n"
)
cat("Longest ride:", max(all_trips_v2$ride_length), "seconds.\n")
cat("Shortest ride:", min(all_trips_v2$ride_length), "seconds.\n")
```

# Summary of ride_length (in seconds).
```{r ride-length-summary}
summary(all_trips_v2$ride_length)
```

# Compare members and casual riders on ride_length.
```{r compare-ride-length}
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = mean)
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = median)
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = max)
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = min)
```

# See the average ride time by each day for members vs casual riders.
```{r compare-ride-length-by-day}
aggregate(
  all_trips_v2$ride_length ~
    all_trips_v2$member_casual + all_trips_v2$day_of_week,
  FUN = mean
)
```

# Notice that the days of week are out of order. Let's fix that.
```{r weekday-order}
all_trips_v2$day_of_week <- ordered(
  all_trips_v2$day_of_week,
  levels = c(
    "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
  )
)
```

# Now, let's run the average ride time by each day for members vs casual riders again.
```{r compare-ride-length-by-day-again}
aggregate(
  all_trips_v2$ride_length ~
    all_trips_v2$member_casual + all_trips_v2$day_of_week,
  FUN = mean
)
```

# Analyze ridership data by rider type and weekday.
```{r analysis-by-type-weekday}
all_trips_v2 %>%
  # creates short name of day of week - 'Mon'
  mutate(weekday = wday(started_at, label = TRUE)) %>%
  group_by(member_casual, weekday) %>% # groups by rider type and weekday
  summarise(
    number_of_rides = n(), # calculates the number of rides
    average_duration = mean(ride_length), # calculates the average duration
    .groups = "drop" # drops all levels of grouping
  ) %>%
  arrange(member_casual, weekday) # sorts data by rider type and then by wekday
```

# Let's visualize the number of rides by rider type.
```{r ride-numbers-viz}
all_trips_v2 %>%
  mutate(weekday = wday(started_at, label = TRUE)) %>%
  group_by(member_casual, weekday) %>%
  summarise(
    number_of_rides = n(),
    .groups = "drop"
  ) %>%
  arrange(member_casual, weekday) %>%
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(
    title = "Number of rides for Annual members VS Casual riders",
    x = "Day of the week",
    y = "Number of rides"
  )
```

# Let's create visualization for average duration.
```{r average-duration-viz}
all_trips_v2 %>%
  mutate(weekday = wday(started_at, label = TRUE)) %>%
  group_by(member_casual, weekday) %>%
  summarise(
    average_duration = mean(ride_length),
    .groups = "drop"
  ) %>%
  arrange(member_casual, weekday) %>%
  ggplot(aes(x = weekday, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(
    title = "Average ride durations for Annual members VS Casual riders",
    x = "Day of the week",
    y = "Average ride durations (in seconds)"
  )
```

# Export summary files for further analysis
```{r export-summary}
analysis_summary <- all_trips_v2 %>%
  mutate(weekday = wday(started_at, label = TRUE)) %>%
  group_by(member_casual, weekday) %>%
  summarise(
    number_of_rides = n(),
    average_duration = mean(ride_length),
    .groups = "drop"
  ) %>%
  arrange(member_casual, weekday)
write.csv(analysis_summary, file = "analysis_summary.csv")
```

# [View the interactive Tableau Dashboard on Tableau Public](https://public.tableau.com/views/CyclisticBike-shareAnalysis_17481008517970/CyclisticBike-shareAnalysis)

# Conclusion
1. From the Cyclistic finance analyst's conclusion, the annual members are much more profitable than casual riders.
2. Annual members are taking more rides with shorter average ride durations mainly on weekdays, possibly for commuting to work.
3. We can develop a campaign focused on cost savings and convenience of annual memberships for weekday commuters.

# Next steps
1. I will work with my team on other questions to design an effective marketing strategy to convert casual riders into annual members. 
2. Cyclistic have 8% ridership from the riders using assistive options only. But the current proxy data do not have relevant information to analyze this. 






























